name: Convert Markdown to PDF

on:
  push:
    branches: [main, master]
    paths:
      - "**/*.md"
      - ".github/config/styles/**"
  workflow_dispatch:
    inputs:
      rebuild_all:
        description: 'Force rebuild all PDFs (ignore incremental setting)'
        required: false
        default: false
        type: boolean

jobs:
  convert-to-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          sudo apt-get update
          
          # Install base packages first
          sudo apt-get install -y \
            pandoc \
            weasyprint \
            fonts-noto \
            fonts-noto-cjk \
            fonts-noto-color-emoji \
            fonts-firacode \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libgbm1
          
          # Handle libasound2 package name change in Ubuntu 24.04+
          # Try libasound2t64 first (Ubuntu 24.04+), fall back to libasound2
          sudo apt-get install -y libasound2t64 || sudo apt-get install -y libasound2
          
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          npm install -g @mermaid-js/mermaid-cli

      - name: Create Mermaid config
        run: |
          cat > /tmp/mermaid-config.json << 'EOF'
          {
            "theme": "default",
            "themeVariables": {
              "fontFamily": "Noto Sans, sans-serif"
            }
          }
          EOF
          
          cat > /tmp/puppeteer-config.json << 'EOF'
          {
            "args": ["--no-sandbox", "--disable-setuid-sandbox"]
          }
          EOF

      - name: Convert Markdown to PDF
        env:
          FORCE_REBUILD: ${{ github.event.inputs.rebuild_all }}
        run: |
          set -e
          
          CONFIG_FILE=".github/config/md-to-pdf-config.yml"
          HEADER_FILE=".github/config/header.md"
          MERMAID_CONFIG="/tmp/mermaid-config.json"
          PUPPETEER_CONFIG="/tmp/puppeteer-config.json"
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Load Configuration
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          load_config() {
            OUTPUT_DIR=$(yq '.output_dir // "output"' "$CONFIG_FILE")
            CSS_FILE=$(yq '.css_file // ".github/config/styles/print.css"' "$CONFIG_FILE")
            INCREMENTAL=$(yq '.incremental // false' "$CONFIG_FILE")
            SOURCE_COUNT=$(yq '.sources | length' "$CONFIG_FILE")
            
            echo "ğŸ“ Output directory: $OUTPUT_DIR"
            echo "ğŸ¨ CSS file: $CSS_FILE"
            echo "ğŸ”„ Incremental: $INCREMENTAL"
            echo "ğŸ“š Sources: $SOURCE_COUNT"
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Determine Build Mode
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          determine_build_mode() {
            if [[ "$FORCE_REBUILD" == "true" ]]; then
              BUILD_MODE="full"
              echo "ğŸ”¨ Build mode: FULL (manual trigger)"
              return
            fi
            
            if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q ".github/config/styles/"; then
              BUILD_MODE="full"
              echo "ğŸ¨ Build mode: FULL (styles changed)"
              return
            fi
            
            if [[ "$INCREMENTAL" == "true" ]]; then
              BUILD_MODE="incremental"
              echo "âš¡ Build mode: INCREMENTAL (from config)"
            else
              BUILD_MODE="full"
              echo "ğŸ”¨ Build mode: FULL (from config)"
            fi
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Get Changed Files
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          get_changed_files() {
            if [[ "$BUILD_MODE" == "incremental" ]]; then
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- '*.md' 2>/dev/null | tr '\n' ' ')
              echo "ğŸ“ Changed files: ${CHANGED_FILES:-none}"
            else
              CHANGED_FILES=""
            fi
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Process Mermaid Diagrams (PNG output for better compatibility)
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          process_mermaid() {
            local input_file="$1"
            local work_dir="$2"
            local temp_md=$(mktemp)
            local counter=0
            local in_mermaid=false
            local fence_char=""
            local mermaid_content=""
            local mermaid_dir="$work_dir/.mermaid_$(basename "$input_file" .md)"
            
            mkdir -p "$mermaid_dir"
            
            while IFS= read -r line || [[ -n "$line" ]]; do
              # Check for mermaid block start (both ``` and ~~~)
              if [[ "$line" =~ ^(\`\`\`|~~~)[[:space:]]*mermaid[[:space:]]*$ ]]; then
                in_mermaid=true
                fence_char="${BASH_REMATCH[1]}"
                mermaid_content=""
              # Check for matching fence end
              elif [[ "$in_mermaid" == true ]] && [[ "$line" =~ ^${fence_char}[[:space:]]*$ ]]; then
                in_mermaid=false
                counter=$((counter + 1))
                local mmd_file="$mermaid_dir/diagram_${counter}.mmd"
                local png_file="$mermaid_dir/diagram_${counter}.png"
                
                # Write mermaid content to temp file
                printf '%s' "$mermaid_content" > "$mmd_file"
                
                # Render mermaid to PNG (better text rendering than SVG)
                if mmdc -i "$mmd_file" -o "$png_file" \
                   -c "$MERMAID_CONFIG" \
                   -p "$PUPPETEER_CONFIG" \
                   -s 2 \
                   -b white \
                   2>/dev/null; then
                  echo "   ğŸ¨ Rendered Mermaid diagram $counter"
                  echo "![Diagram](${png_file})" >> "$temp_md"
                else
                  echo "   âš ï¸ Failed to render Mermaid diagram $counter, keeping as code"
                  echo '```' >> "$temp_md"
                  echo "$mermaid_content" >> "$temp_md"
                  echo '```' >> "$temp_md"
                fi
                fence_char=""
              elif [[ "$in_mermaid" == true ]]; then
                mermaid_content+="$line"$'\n'
              else
                echo "$line" >> "$temp_md"
              fi
            done < "$input_file"
            
            cat "$temp_md"
            rm -f "$temp_md"
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Preprocess Obsidian Syntax
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          preprocess_obsidian() {
            sed 's/%%[^%]*%%//g' | \
            sed 's/==\([^=]*\)==/<mark>\1<\/mark>/g' | \
            sed 's/\[\[\([^]|]*\)\]\]/**\1**/g' | \
            sed 's/\[\[[^]|]*|\([^]]*\)\]\]/**\1**/g' | \
            sed 's/!\[\[\([^]]*\)\]\]/[ğŸ“ \1]/g' | \
            sed 's/^> \[!note\].*/> ğŸ“ **Note**/g' | \
            sed 's/^> \[!info\].*/> â„¹ï¸ **Info**/g' | \
            sed 's/^> \[!tip\].*/> ğŸ’¡ **Tip**/g' | \
            sed 's/^> \[!warning\].*/> âš ï¸ **Warning**/g' | \
            sed 's/^> \[!danger\].*/> ğŸš¨ **Danger**/g' | \
            sed 's/^> \[!example\].*/> ğŸ“Œ **Example**/g' | \
            sed 's/^> \[!question\].*/> â“ **Question**/g' | \
            sed 's/^> \[!success\].*/> âœ… **Success**/g' | \
            sed 's/^> \[!failure\].*/> âŒ **Failure**/g' | \
            sed 's/^> \[!bug\].*/> ğŸ› **Bug**/g' | \
            sed 's/^> \[!quote\].*/> ğŸ’¬ **Quote**/g' | \
            sed 's/^> \[!todo\].*/> â˜ **Todo**/g' | \
            sed 's/^> \[!important\].*/> ğŸ”¥ **Important**/g'
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Helper: Get Base Path from Glob
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          get_base_path() {
            echo "$1" | sed 's/\*.*$//' | sed 's:/$::'
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Helper: Calculate Output Path
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          get_output_path() {
            local file="$1"
            local preserve_full_path="$2"
            local base_path="$3"
            
            if [[ "$preserve_full_path" == "true" ]]; then
              echo "$OUTPUT_DIR/$(dirname "$file")"
            else
              local rel_path="${file#$base_path/}"
              local dir_path=$(dirname "$rel_path")
              if [[ "$dir_path" == "." ]]; then
                echo "$OUTPUT_DIR"
              else
                echo "$OUTPUT_DIR/$dir_path"
              fi
            fi
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Convert Single File
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          convert_file() {
            local file="$1"
            local preserve_full_path="$2"
            local base_path="$3"
            
            local filename=$(basename "$file" .md)
            local output_path=$(get_output_path "$file" "$preserve_full_path" "$base_path")
            local file_dir=$(dirname "$file")
            local temp_processed=$(mktemp)
            local temp_with_header=$(mktemp)
            
            mkdir -p "$output_path"
            
            echo "ğŸ“„ $file â†’ $output_path/$filename.pdf"
            
            # Prepend header file if it exists
            if [[ -f "$HEADER_FILE" ]]; then
              cat "$HEADER_FILE" > "$temp_with_header"
              echo "" >> "$temp_with_header"
              echo "" >> "$temp_with_header"
            fi
            
            # Check if file contains mermaid diagrams (both ``` and ~~~)
            if grep -qE '^(\`\`\`|~~~)mermaid' "$file"; then
              echo "   ğŸ” Found Mermaid diagrams, processing..."
              process_mermaid "$file" "$file_dir" | preprocess_obsidian >> "$temp_with_header"
            else
              cat "$file" | preprocess_obsidian >> "$temp_with_header"
            fi
            
            mv "$temp_with_header" "$temp_processed"
            
            if pandoc "$temp_processed" \
              -o "$output_path/$filename.pdf" \
              --pdf-engine=weasyprint \
              --css="$CSS_FILE" \
              --wrap=none \
              --standalone \
              --resource-path=".:$file_dir:$file_dir/.mermaid_$filename" \
              2>&1; then
              echo "   âœ… Success"
              rm -f "$temp_processed"
              rm -rf "$file_dir/.mermaid_$filename"
              return 0
            else
              echo "   âš ï¸ Failed"
              rm -f "$temp_processed"
              rm -rf "$file_dir/.mermaid_$filename"
              return 1
            fi
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Get Files to Convert for a Source
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          get_files_for_source() {
            local glob="$1"
            local base_path="$2"
            
            FILES_TO_CONVERT=()
            
            if [[ "$BUILD_MODE" == "full" ]]; then
              shopt -s globstar nullglob
              FILES_TO_CONVERT=( $glob )
              shopt -u globstar nullglob
            else
              for changed_file in $CHANGED_FILES; do
                if [[ -f "$changed_file" ]] && [[ "$changed_file" == $base_path/* ]]; then
                  FILES_TO_CONVERT+=("$changed_file")
                fi
              done
            fi
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Process Single Source
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          process_source() {
            local index="$1"
            
            local glob=$(yq ".sources[$index].glob" "$CONFIG_FILE")
            local preserve_full_path=$(yq ".sources[$index].preserve_full_path // false" "$CONFIG_FILE")
            local enabled=$(yq ".sources[$index].enabled // true" "$CONFIG_FILE")
            local base_path=$(get_base_path "$glob")
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“‚ Source: $glob"
            
            if [[ "$enabled" != "true" ]]; then
              echo "   â­ï¸ Skipped (disabled)"
              return
            fi
            
            get_files_for_source "$glob" "$base_path"
            
            if [[ ${#FILES_TO_CONVERT[@]} -eq 0 ]]; then
              echo "   ğŸ“­ No files to convert"
              return
            fi
            
            echo "   ğŸ“ Files: ${#FILES_TO_CONVERT[@]}"
            
            for file in "${FILES_TO_CONVERT[@]}"; do
              convert_file "$file" "$preserve_full_path" "$base_path"
            done
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Main
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          main() {
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“š Markdown to PDF Converter (with Mermaid support)"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            load_config
            echo ""
            
            determine_build_mode
            get_changed_files
            echo ""
            
            mkdir -p "$OUTPUT_DIR"
            
            for i in $(seq 0 $((SOURCE_COUNT - 1))); do
              process_source "$i"
            done
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Conversion complete!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          }
          
          main

      - name: Commit and push PDFs
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -f output/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ“„ Auto-generate PDFs [skip ci]" && git push)
