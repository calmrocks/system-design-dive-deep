name: Convert Markdown to PDF

on:
  push:
    branches: [main, master]
    paths:
      - "**/*.md"
      - ".github/config/styles/**"
  workflow_dispatch:
    inputs:
      rebuild_all:
        description: 'Force rebuild all PDFs (ignore incremental setting)'
        required: false
        default: false
        type: boolean

jobs:
  convert-to-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 2

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            weasyprint \
            fonts-noto \
            fonts-noto-cjk \
            fonts-noto-color-emoji \
            fonts-firacode
          
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Convert Markdown to PDF
        env:
          FORCE_REBUILD: ${{ github.event.inputs.rebuild_all }}
        run: |
          set -e
          
          CONFIG_FILE=".github/config/md-to-pdf-config.yml"
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Load Configuration
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          load_config() {
            OUTPUT_DIR=$(yq '.output_dir // "output"' "$CONFIG_FILE")
            CSS_FILE=$(yq '.css_file // ".github/config/styles/print.css"' "$CONFIG_FILE")
            INCREMENTAL=$(yq '.incremental // false' "$CONFIG_FILE")
            SOURCE_COUNT=$(yq '.sources | length' "$CONFIG_FILE")
            
            echo "ğŸ“ Output directory: $OUTPUT_DIR"
            echo "ğŸ¨ CSS file: $CSS_FILE"
            echo "ğŸ”„ Incremental: $INCREMENTAL"
            echo "ğŸ“š Sources: $SOURCE_COUNT"
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Determine Build Mode
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          determine_build_mode() {
            # Force rebuild via manual trigger
            if [[ "$FORCE_REBUILD" == "true" ]]; then
              BUILD_MODE="full"
              echo "ğŸ”¨ Build mode: FULL (manual trigger)"
              return
            fi
            
            # Check if styles changed
            if git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q ".github/config/styles/"; then
              BUILD_MODE="full"
              echo "ğŸ¨ Build mode: FULL (styles changed)"
              return
            fi
            
            # Use config setting
            if [[ "$INCREMENTAL" == "true" ]]; then
              BUILD_MODE="incremental"
              echo "âš¡ Build mode: INCREMENTAL (from config)"
            else
              BUILD_MODE="full"
              echo "ğŸ”¨ Build mode: FULL (from config)"
            fi
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Get Changed Files
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          get_changed_files() {
            if [[ "$BUILD_MODE" == "incremental" ]]; then
              CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- '*.md' 2>/dev/null | tr '\n' ' ')
              echo "ğŸ“ Changed files: ${CHANGED_FILES:-none}"
            else
              CHANGED_FILES=""
            fi
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Preprocess Obsidian Syntax
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          preprocess() {
            cat "$1" | \
            sed 's/%%[^%]*%%//g' | \
            sed 's/==\([^=]*\)==/<mark>\1<\/mark>/g' | \
            sed 's/\[\[\([^]|]*\)\]\]/**\1**/g' | \
            sed 's/\[\[[^]|]*|\([^]]*\)\]\]/**\1**/g' | \
            sed 's/!\[\[\([^]]*\)\]\]/[ğŸ“ \1]/g' | \
            sed 's/^> \[!note\].*/> ğŸ“ **Note**/g' | \
            sed 's/^> \[!info\].*/> â„¹ï¸ **Info**/g' | \
            sed 's/^> \[!tip\].*/> ğŸ’¡ **Tip**/g' | \
            sed 's/^> \[!warning\].*/> âš ï¸ **Warning**/g' | \
            sed 's/^> \[!danger\].*/> ğŸš¨ **Danger**/g' | \
            sed 's/^> \[!example\].*/> ğŸ“Œ **Example**/g' | \
            sed 's/^> \[!question\].*/> â“ **Question**/g' | \
            sed 's/^> \[!success\].*/> âœ… **Success**/g' | \
            sed 's/^> \[!failure\].*/> âŒ **Failure**/g' | \
            sed 's/^> \[!bug\].*/> ğŸ› **Bug**/g' | \
            sed 's/^> \[!quote\].*/> ğŸ’¬ **Quote**/g' | \
            sed 's/^> \[!todo\].*/> â˜ **Todo**/g' | \
            sed 's/^> \[!important\].*/> ğŸ”¥ **Important**/g'
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Helper: Get Base Path from Glob
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          get_base_path() {
            echo "$1" | sed 's/\*.*$//' | sed 's:/$::'
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Helper: Calculate Output Path
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          get_output_path() {
            local file="$1"
            local preserve_full_path="$2"
            local base_path="$3"
            
            if [[ "$preserve_full_path" == "true" ]]; then
              echo "$OUTPUT_DIR/$(dirname "$file")"
            else
              local rel_path="${file#$base_path/}"
              local dir_path=$(dirname "$rel_path")
              if [[ "$dir_path" == "." ]]; then
                echo "$OUTPUT_DIR"
              else
                echo "$OUTPUT_DIR/$dir_path"
              fi
            fi
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Convert Single File
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          convert_file() {
            local file="$1"
            local preserve_full_path="$2"
            local base_path="$3"
            
            local filename=$(basename "$file" .md)
            local output_path=$(get_output_path "$file" "$preserve_full_path" "$base_path")
            
            mkdir -p "$output_path"
            
            echo "ğŸ“„ $file â†’ $output_path/$filename.pdf"
            
            if preprocess "$file" | pandoc \
              -o "$output_path/$filename.pdf" \
              --pdf-engine=weasyprint \
              --css="$CSS_FILE" \
              --wrap=none \
              --standalone \
              --resource-path="$(dirname "$file")" \
              2>&1; then
              echo "   âœ… Success"
              return 0
            else
              echo "   âš ï¸ Failed"
              return 1
            fi
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Get Files to Convert for a Source
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          get_files_for_source() {
            local glob="$1"
            local base_path="$2"
            
            FILES_TO_CONVERT=()
            
            if [[ "$BUILD_MODE" == "full" ]]; then
              # Get all files matching glob
              shopt -s globstar nullglob
              FILES_TO_CONVERT=( $glob )
              shopt -u globstar nullglob
            else
              # Get only changed files matching this source
              for changed_file in $CHANGED_FILES; do
                if [[ -f "$changed_file" ]] && [[ "$changed_file" == $base_path/* ]]; then
                  FILES_TO_CONVERT+=("$changed_file")
                fi
              done
            fi
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Process Single Source
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          process_source() {
            local index="$1"
            
            local glob=$(yq ".sources[$index].glob" "$CONFIG_FILE")
            local preserve_full_path=$(yq ".sources[$index].preserve_full_path // false" "$CONFIG_FILE")
            local enabled=$(yq ".sources[$index].enabled // true" "$CONFIG_FILE")
            local base_path=$(get_base_path "$glob")
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“‚ Source: $glob"
            
            if [[ "$enabled" != "true" ]]; then
              echo "   â­ï¸ Skipped (disabled)"
              return
            fi
            
            get_files_for_source "$glob" "$base_path"
            
            if [[ ${#FILES_TO_CONVERT[@]} -eq 0 ]]; then
              echo "   ğŸ“­ No files to convert"
              return
            fi
            
            echo "   ğŸ“ Files: ${#FILES_TO_CONVERT[@]}"
            
            for file in "${FILES_TO_CONVERT[@]}"; do
              convert_file "$file" "$preserve_full_path" "$base_path"
            done
          }
          
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          # Main
          #â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          main() {
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸ“š Markdown to PDF Converter"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            load_config
            echo ""
            
            determine_build_mode
            get_changed_files
            echo ""
            
            mkdir -p "$OUTPUT_DIR"
            
            for i in $(seq 0 $((SOURCE_COUNT - 1))); do
              process_source "$i"
            done
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Conversion complete!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          }
          
          # Run
          main

      - name: Commit and push PDFs
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -f output/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ“„ Auto-generate PDFs [skip ci]" && git push)
